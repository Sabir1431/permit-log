<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Construction Permit Log System</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script>
    const { useState, useEffect } = React;
    const e = React.createElement;

    // === IMPORTANT: paste your Apps Script "exec" URL here ===
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQaDcmdWmIQHiHXMPabGpLYEefn5jW-T1ZJREOL-N53JXPfiudzCJYTp0fnSjaVjMm/exec';

    function PermitLogSystem() {
      const [project, setProject] = useState('TWS O-16123');
      const [permitType, setPermitType] = useState('');
      const [permits, setPermits] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [notification, setNotification] = useState('');
      const [syncing, setSyncing] = useState(false);
      const [loading, setLoading] = useState(false);

      const projects = ['TWS O-16123', 'TW O-16124'];

      const permitTypes = [
        { id: 'confined-space', name: 'SOF-3542-I Confined Space Entry', color: 'bg-blue-100 border-blue-300' },
        { id: 'excavation',     name: 'SOF-3542-H Excavation',           color: 'bg-green-100 border-green-300' },
        { id: 'work-height',    name: 'SOF-3542-E Work at Height',       color: 'bg-yellow-100 border-yellow-300' },
        { id: 'lifting',        name: 'SOF-3542-C Lifting Operation',    color: 'bg-purple-100 border-purple-300' }
      ];

      const [formData, setFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        time: new Date().toTimeString().split(' ')[0].substring(0, 5),
        location: '',
        contractor: '',
        supervisor: '',
        workDescription: '',
        hazards: '',
        controlMeasures: '',
        permitIssuer: '',
        validFrom: '',
        validTo: '',
        status: 'Active'
      });

      // -------- READ from Google Sheets whenever project changes --------
      useEffect(() => {
        (async () => { await fetchPermitsFromSheet(project); })();
      }, [project]);

      async function fetchPermitsFromSheet(proj) {
        try {
          setLoading(true);
          const url = `${APPS_SCRIPT_URL}?action=list&project=${encodeURIComponent(proj)}`;
          const res = await fetch(url, { method: 'GET' });
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'Failed to load');
          // Map rows from sheet headers into the UI model
          const list = (json.rows || []).map((r, idx) => {
            return {
              id: `${Date.now()}_${idx}`,
              project: proj,
              permitType: '', // we store only display name from the sheet
              permitTypeName: (r['Permit Type'] || '').toString(),
              date: (r['Date'] || '').toString(),
              time: (r['Time'] || '').toString(),
              location: (r['Location'] || '').toString(),
              contractor: (r['Contractor'] || '').toString(),
              supervisor: (r['Supervisor'] || '').toString(),
              workDescription: (r['Work Description'] || '').toString(),
              hazards: (r['Hazards'] || '').toString(),
              controlMeasures: (r['Control Measure'] || '').toString(),
              permitIssuer: (r['Permit Issuer'] || '').toString(),
              validFrom: (r['Valid From'] || '').toString(),
              validTo: (r['Valid To'] || '').toString(),
              status: (r['Status'] || '').toString() || 'Active'
            };
          });
          // Most recent at the top if your sheet is chronological
          setPermits(list.reverse());
          setNotification('â˜ï¸ Loaded from Google Sheets');
        } catch (err) {
          console.error(err);
          setNotification('âš ï¸ Could not load from Google Sheets');
        } finally {
          setTimeout(() => setNotification(''), 2500);
          setLoading(false);
        }
      }

      // -------- WRITE to Google Sheets --------
      async function syncToGoogleSheets(permitData) {
        try {
          setSyncing(true);
          // application/x-www-form-urlencoded keeps it a "simple" POST (no preflight)
          const payload = new URLSearchParams();
          payload.append('payload', JSON.stringify({
            project: project,
            date: permitData.date,
            time: permitData.time,
            permitTypeName: permitData.permitTypeName,
            location: permitData.location,
            contractor: permitData.contractor,
            supervisor: permitData.supervisor,
            workDescription: permitData.workDescription,
            hazards: permitData.hazards,
            controlMeasures: permitData.controlMeasures,
            permitIssuer: permitData.permitIssuer,
            validFrom: permitData.validFrom,
            validTo: permitData.validTo,
            status: permitData.status
          }));

          const res = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body: payload.toString()
          });
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'Apps Script error');
          return true;
        } catch (err) {
          console.error('Error syncing to Google Sheets:', err);
          return false;
        } finally {
          setSyncing(false);
        }
      }

      // -------- Submit handler --------
      async function handleSubmit() {
        if (!permitType || !formData.date || !formData.location || !formData.contractor || !formData.supervisor) {
          setNotification('âš ï¸ Please fill in all required fields.');
          setTimeout(() => setNotification(''), 3000);
          return;
        }
        const permitTypeName = permitTypes.find(p => p.id === permitType).name;

        const newPermit = {
          id: Date.now(),
          project,
          permitType,
          permitTypeName,
          date: formData.date,
          time: formData.time,
          location: formData.location,
          contractor: formData.contractor,
          supervisor: formData.supervisor,
          workDescription: formData.workDescription,
          hazards: formData.hazards,
          controlMeasures: formData.controlMeasures,
          permitIssuer: formData.permitIssuer,
          validFrom: formData.validFrom,
          validTo: formData.validTo,
          status: formData.status,
          createdAt: new Date().toISOString()
        };

        setNotification('ðŸ’¾ Saving to Google Sheetsâ€¦');
        const ok = await syncToGoogleSheets(newPermit);
        if (ok) {
          setNotification('âœ… Saved to Google Sheets');
          // Refresh from the authoritative source
          await fetchPermitsFromSheet(project);
        } else {
          setNotification('âŒ Save failed');
        }
        setTimeout(() => setNotification(''), 3000);
        setShowForm(false);
        resetForm();
      }

      function resetForm() {
        setFormData({
          date: new Date().toISOString().split('T')[0],
          time: new Date().toTimeString().split(' ')[0].substring(0, 5),
          location: '',
          contractor: '',
          supervisor: '',
          workDescription: '',
          hazards: '',
          controlMeasures: '',
          permitIssuer: '',
          validFrom: '',
          validTo: '',
          status: 'Active'
        });
        setPermitType('');
      }

      function downloadCSV() {
        const headers = ['Date','Time','Permit Type','Location','Contractor','Supervisor','Work Description','Hazards','Control Measure','Permit Issuer','Valid From','Valid To','Status'];
        const rows = permits.map(p => [
          p.date, p.time, p.permitTypeName, p.location, p.contractor, p.supervisor, p.workDescription,
          p.hazards, p.controlMeasures, p.permitIssuer, p.validFrom, p.validTo, p.status
        ]);
        const csv = [headers.join(',')].concat(rows.map(r => r.map(x => `"${(x||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Permit_Log_${project}_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // -------- UI --------
      return e('div', { className: 'min-h-screen p-6' },
        e('div', { className: 'max-w-7xl mx-auto' },
          e('div', { className: 'bg-white rounded-lg shadow p-6 mb-6' },
            e
