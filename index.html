/***** CONFIG *****/
const SHEET_IDS = {
  'TWS O-16123': '1eqRc318-sQ7qZYMDlmfVCqo7Gu6_Z3HCbaqFDgE3hiI',
  'TW O-16124' : '1eqRc318-sQ7qZYMDlmfVCqo7Gu6_Z3HCbaqFDgE3hiI' // same file, different tab
};

const TAB_NAMES = {
  'TWS O-16123': 'TWS O-16123 Permit Log',
  'TW O-16124' : 'TWS O-16124 Permit Log'
};

/***** HELPERS *****/
function getSheet(project) {
  const id = SHEET_IDS[project];
  if (!id) throw new Error(`Unknown project: ${project}`);
  const ss = SpreadsheetApp.openById(id);
  const tab = TAB_NAMES[project] || project;
  const sh = ss.getSheetByName(tab) || ss.getSheets()[0];
  if (!sh) throw new Error(`Sheet tab not found: ${tab}`);
  return sh;
}

function rowsToObjects(values) {
  if (!values || !values.length) return { headers: [], rows: [] };
  const headers = values[0].map(String);
  const rows = [];
  for (let i = 1; i < values.length; i++) {
    const r = values[i];
    if (!r || r.join('').trim() === '') continue;
    const o = {};
    headers.forEach((h, j) => o[h] = r[j] ?? '');
    rows.push(o);
  }
  return { headers, rows };
}

/***** API *****/
function doGet(e) {
  try {
    const action = e?.parameter?.action || 'ping';

    if (action === 'list') {
      const project = e.parameter.project;
      if (!project) throw new Error('Missing ?project=');
      const sh = getSheet(project);
      const parsed = rowsToObjects(sh.getDataRange().getValues());
      return ContentService.createTextOutput(JSON.stringify({
        ok: true,
        project,
        sheet: sh.getName(),
        headers: parsed.headers,
        rows: parsed.rows
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // default ping
    return ContentService.createTextOutput(JSON.stringify({ ok: true, message: 'ping' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ ok: false, error: String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    if (!e) throw new Error('No event payload');

    // Accept x-www-form-urlencoded body ("payload"=JSON) or raw JSON
    let body = e.parameter?.payload || e.postData?.contents || '{}';
    try { body = decodeURIComponent(body); } catch (_) {}
    const data = JSON.parse(body);

    const sh = getSheet(data.project);

    // Append in header order (includes Permit No.)
    sh.appendRow([
      data.date || '',
      data.time || '',
      data.permitNo || '',
      data.permitTypeName || '',
      data.location || '',
      data.contractor || '',
      data.supervisor || '',
      data.workDescription || '',
      data.hazards || '',
      data.controlMeasures || '',
      data.permitIssuer || '',
      data.validFrom || '',
      data.validTo || '',
      data.status || 'Active'
    ]);

    return ContentService.createTextOutput(JSON.stringify({
      ok: true,
      message: 'Row appended',
      project: data.project,
      sheet: sh.getName()
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ ok: false, error: String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
