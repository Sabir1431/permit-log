<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Permit Log System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useEffect } = React;
        const e = React.createElement;

        // âš ï¸ IMPORTANT: Replace this with your Google Apps Script URL if you want to sync with Sheets
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIXrLd5Ohi-pjx00g0_lckJUjxkbPBBh3BbillaDVUCrVD5r-IjKEdZ1ezKEjcnuIj/exec';

        function PermitLogSystem() {
            const [project, setProject] = useState('TWS O-16123');
            const [permitType, setPermitType] = useState('');
            const [permits, setPermits] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [notification, setNotification] = useState('');
            const [loading, setLoading] = useState(false);

            const projects = ['TWS O-16123', 'TW O-16124'];
            
            const permitTypes = [
                { id: 'confined-space', name: 'SOF-3542-I Confined Space Entry', color: 'bg-blue-100 border-blue-300' },
                { id: 'excavation', name: 'SOF-3542-H Excavation', color: 'bg-green-100 border-green-300' },
                { id: 'work-height', name: 'SOF-3542-E Work at Height', color: 'bg-yellow-100 border-yellow-300' },
                { id: 'lifting', name: 'SOF-3542-C Lifting Operation', color: 'bg-purple-100 border-purple-300' }
            ];

            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().split(' ')[0].substring(0, 5),
                location: '',
                contractor: '',
                supervisor: '',
                workDescription: '',
                hazards: '',
                controlMeasures: '',
                permitIssuer: '',
                validFrom: '',
                validTo: '',
                status: 'Active'
            });

            useEffect(() => {
                loadPermits();
            }, [project]);

            const loadPermits = () => {
                const stored = localStorage.getItem(`permits_${project}`);
                if (stored) {
                    setPermits(JSON.parse(stored));
                } else {
                    setPermits([]);
                }
            };

            const savePermits = (newPermits) => {
                localStorage.setItem(`permits_${project}`, JSON.stringify(newPermits));
                setPermits(newPermits);
            };

            const handleSubmit = () => {
                if (!permitType || !formData.date || !formData.location || !formData.contractor || !formData.supervisor) {
                    setNotification('âš ï¸ Please fill in all required fields!');
                    setTimeout(() => setNotification(''), 3000);
                    return;
                }
                
                const permitTypeName = permitTypes.find(p => p.id === permitType)?.name;
                
                const newPermit = {
                    id: Date.now(),
                    project,
                    permitType,
                    permitTypeName,
                    ...formData,
                    createdAt: new Date().toISOString()
                };

                const updatedPermits = [newPermit, ...permits];
                savePermits(updatedPermits);
                
                setNotification('âœ“ Permit logged successfully!');
                setTimeout(() => setNotification(''), 3000);
                
                setShowForm(false);
                resetForm();
            };

            const resetForm = () => {
                setFormData({
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toTimeString().split(' ')[0].substring(0, 5),
                    location: '',
                    contractor: '',
                    supervisor: '',
                    workDescription: '',
                    hazards: '',
                    controlMeasures: '',
                    permitIssuer: '',
                    validFrom: '',
                    validTo: '',
                    status: 'Active'
                });
                setPermitType('');
            };

            const downloadCSV = () => {
                const headers = ['Date', 'Time', 'Permit Type', 'Location', 'Contractor', 'Supervisor', 'Work Description', 'Hazards', 'Control Measures', 'Permit Issuer', 'Valid From', 'Valid To', 'Status'];
                
                const rows = permits.map(permit => [
                    permit.date,
                    permit.time,
                    permit.permitTypeName,
                    permit.location,
                    permit.contractor,
                    permit.supervisor,
                    permit.workDescription,
                    permit.hazards,
                    permit.controlMeasures,
                    permit.permitIssuer,
                    permit.validFrom,
                    permit.validTo,
                    permit.status
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell || ''}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Permit_Log_${project}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                setNotification('âœ“ Log downloaded successfully!');
                setTimeout(() => setNotification(''), 3000);
            };

            return e('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6' },
                e('div', { className: 'max-w-7xl mx-auto' },
                    e('div', { className: 'bg-white rounded-lg shadow-lg p-6 mb-6' },
                        e('div', { className: 'flex items-center justify-between mb-4' },
                            e('h1', { className: 'text-3xl font-bold text-gray-800' }, 'ðŸ—ï¸ Construction Permit Log System'),
                            e('button', {
                                onClick: () => setShowForm(!showForm),
                                className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition'
                            }, 'âž• New Permit')
                        ),
                        e('div', { className: 'flex gap-4 items-center flex-wrap' },
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Project'),
                                e('select', {
                                    value: project,
                                    onChange: (ev) => setProject(ev.target.value),
                                    className: 'border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none'
                                },
                                    projects.map(proj =>
                                        e('option', { key: proj, value: proj }, proj)
                                    )
                                )
                            ),
                            e('div', { className: 'flex-1' }),
                            e('button', {
                                onClick: downloadCSV,
                                disabled: permits.length === 0,
                                className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400'
                            }, 'ðŸ“¥ Download CSV')
                        )
                    ),
                    
                    notification && e('div', {
                        className: `${notification.includes('âœ“') ? 'bg-green-100 border-green-400 text-green-700' : 'bg-orange-100 border-orange-400 text-orange-700'} border px-4 py-3 rounded-lg mb-6`
                    }, notification)
                )
            );
        }

        ReactDOM.render(
            e(PermitLogSystem),
            document.getElementById('root')
        );
    </script>
</body>
</html>