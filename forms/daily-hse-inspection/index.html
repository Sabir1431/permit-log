/**
 * HSE Inspection Web App (Drive + Word Export)
 * - doPost: saves payload to Drive (same as your current flow)
 * - NEW: /exec?mode=export&folderId=...  OR POST { mode:"export", folderId:"..." }
 * - Generates Google Doc report from report.json + images in the same folder
 * - Exports as DOCX into the same folder
 *
 * DEPLOY:
 * - Execute as: Me (USER_DEPLOYING)
 * - Access: Anyone
 * - After adding Documents scope: Run testAuthorize_() then Deploy NEW VERSION
 */

// ===========================
// CONFIGURATION
// ===========================
const PROJECT_FOLDERS = {
  "TAQA WS O-16123": "1gMRc-OhcScKCDz5Z4xRI3Ba49if8pQBC",
  "TAQA WS O-16124": "1A7rrudDh4KBd6c6DsiA0bnCe7PtDx7mF"
};

const API_TOKEN = "HSE-TAQA-2026-SECURE-KEY-98321";
const ALLOW_NO_TOKEN_FOR_TESTING = false;
const ALLOWED_DOMAIN = ""; // keep "" to disable

// ===========================
// ENTRY POINTS
// ===========================

function doGet(e) {
  const mode = (e && e.parameter && e.parameter.mode) ? String(e.parameter.mode) : "health";

  if (mode === "drive") {
    const sanity = driveSanityCheck_();
    return jsonResponse_({ ok: true, mode: "drive", driveSanity: sanity }, 200);
  }

  if (mode === "export") {
    const folderId = (e && e.parameter && e.parameter.folderId) ? String(e.parameter.folderId) : "";
    if (!folderId) return jsonResponse_({ ok: false, message: "Missing folderId for export." }, 400);

    const result = createAndExportWordReport_(folderId);
    return jsonResponse_({ ok: true, mode: "export", ...result }, 200);
  }

  return jsonResponse_({
    ok: true,
    mode: "health",
    message: "HSE Inspection Drive API is running.",
    projects: Object.keys(PROJECT_FOLDERS),
    hint: "Use ?mode=drive to verify DriveApp. Use ?mode=export&folderId=FOLDER_ID to create DOCX."
  }, 200);
}

function doPost(e) {
  try {
    assertDriveAppAvailable_();

    if (!e || !e.postData || !e.postData.contents) {
      return jsonResponse_({ ok: false, message: "Missing request body." }, 400);
    }

    const payload = JSON.parse(e.postData.contents);

    // Optional: allow POST export
    if (String(payload.mode || "").toLowerCase() === "export") {
      const tokenOk = validateToken_(payload);
      if (!tokenOk.ok) return jsonResponse_(tokenOk, tokenOk.statusCode);

      const folderId = String(payload.folderId || "").trim();
      if (!folderId) return jsonResponse_({ ok: false, message: "Missing folderId." }, 400);

      const result = createAndExportWordReport_(folderId);
      return jsonResponse_({ ok: true, mode: "export", ...result }, 200);
    }

    // ---------------------------
    // DOMAIN LOCK (optional)
    // ---------------------------
    if (ALLOWED_DOMAIN) {
      const email = safeActiveUserEmail_();
      if (!email) {
        return jsonResponse_({
          ok: false,
          message: "Unauthorized (cannot verify domain). Disable ALLOWED_DOMAIN or deploy in Workspace."
        }, 401);
      }
      const domain = email.split("@").pop().toLowerCase();
      if (domain !== ALLOWED_DOMAIN.toLowerCase()) {
        return jsonResponse_({ ok: false, message: "Unauthorized (domain not allowed)." }, 401);
      }
    }

    // ---------------------------
    // TOKEN VALIDATION
    // ---------------------------
    const tokenOk = validateToken_(payload);
    if (!tokenOk.ok) return jsonResponse_(tokenOk, tokenOk.statusCode);

    // ---------------------------
    // READ REQUIRED FIELDS
    // ---------------------------
    const projectName = String(payload.projectName || "").trim();
    const folderIdFromForm = String(payload.projectFolderId || "").trim();

    const reportDate = String(payload.reportDate || new Date().toISOString().slice(0, 10)).trim();
    const year = reportDate.substring(0, 4);

    const siteLocation = sanitize_(payload.siteLocation || "Unknown_Site");
    const inspectorName = sanitize_(payload.inspectorName || "Unknown_Inspector");
    const reportNumber = sanitize_(payload.reportNumber || buildReportNumber_(reportDate));

    // Resolve project root folder id
    const projectFolderId = folderIdFromForm || PROJECT_FOLDERS[projectName];
    if (!projectFolderId) {
      return jsonResponse_({
        ok: false,
        message: "Project folder not configured. Provide projectFolderId or use a known projectName.",
        projectName
      }, 400);
    }

    // Create structure
    const projectRoot = safeGetFolderById_(projectFolderId, "ProjectRoot");
    const yearFolder = getOrCreateFolderIn_(projectRoot, year);
    const siteFolder = getOrCreateFolderIn_(yearFolder, siteLocation);
    const recordFolder = getOrCreateFolderIn_(siteFolder, reportNumber);

    // Save payload
    payload._server = {
      savedAt: new Date().toISOString(),
      savedBy: safeActiveUserEmail_(),
      projectNameResolved: projectName || "(from folderId)",
      driveFolderId: recordFolder.getId(),
      inspectorName
    };

    recordFolder.createFile("report.json", JSON.stringify(payload, null, 2), MimeType.JSON);

    if (payload.renderedHtml && String(payload.renderedHtml).trim().length > 0) {
      recordFolder.createFile("report.html", String(payload.renderedHtml), MimeType.HTML);
    }

    // signature
    if (payload.signatureData && String(payload.signatureData).startsWith("data:image")) {
      const sigBlob = dataUrlToBlob_(payload.signatureData, "signature.png");
      recordFolder.createFile(sigBlob);
    }

    // photos
    if (Array.isArray(payload.photos) && payload.photos.length > 0) {
      payload.photos.forEach((p, idx) => {
        if (!p || !p.dataUrl || !String(p.dataUrl).startsWith("data:image")) return;

        const ext = guessExt_(p.dataUrl);
        const name = `photo_${String(idx + 1).padStart(2, "0")}.${ext}`;
        const blob = dataUrlToBlob_(p.dataUrl, name);
        recordFolder.createFile(blob);

        if (p.caption && String(p.caption).trim().length > 0) {
          recordFolder.createFile(
            `photo_${String(idx + 1).padStart(2, "0")}_caption.txt`,
            String(p.caption).trim(),
            MimeType.PLAIN_TEXT
          );
        }
      });
    }

    // summary
    const summary = buildSummaryText_(payload, {
      projectName,
      reportNumber,
      reportDate,
      siteLocation,
      inspectorName
    });
    recordFolder.createFile("summary.txt", summary, MimeType.PLAIN_TEXT);

    return jsonResponse_({
      ok: true,
      message: "Saved to Google Drive",
      projectName,
      reportNumber,
      folderName: recordFolder.getName(),
      folderId: recordFolder.getId()
    }, 200);

  } catch (err) {
    return jsonResponse_({ ok: false, message: formatError_(err) }, 500);
  }
}

// ===========================
// WORD EXPORT (DOCX) - MAIN
// ===========================

function createAndExportWordReport_(recordFolderId) {
  assertDriveAppAvailable_();

  // Ensure DocumentApp is available
  if (typeof DocumentApp === "undefined" || !DocumentApp) {
    throw new Error("DocumentApp is not available. Ensure Documents scope is added and you redeployed a NEW VERSION.");
  }

  const recordFolder = safeGetFolderById_(recordFolderId, "RecordFolder");

  // Load report.json
  const reportFile = findFirstFileByName_(recordFolder, "report.json");
  if (!reportFile) {
    throw new Error("report.json not found in the record folder. Cannot generate report.");
  }

  const payload = JSON.parse(reportFile.getBlob().getDataAsString("UTF-8"));

  const meta = {
    reportNumber: payload.reportNumber || recordFolder.getName(),
    reportDate: payload.reportDate || "",
    projectName: payload.projectName || "",
    siteLocation: payload.siteLocation || "",
    areaLocation: payload.areaLocation || "",
    workOrder: payload.workOrder || "",
    permitNo: payload.permitNo || "",
    supervisorName: payload.supervisorName || "",
    contractorName: payload.contractorName || "",
    inspectorName: payload.inspectorName || "",
    geo: payload.geolocation || {}
  };

  // Create Google Doc
  const docTitle = `HSE Inspection Report - ${meta.reportNumber}`;
  const doc = DocumentApp.create(docTitle);
  const docId = doc.getId();

  const body = doc.getBody();
  body.clear();

  // Header
  const title = body.appendParagraph("DAILY HSE INSPECTION REPORT");
  title.setHeading(DocumentApp.ParagraphHeading.HEADING1);

  body.appendParagraph(`Report No: ${meta.reportNumber}`);
  body.appendParagraph(`Date: ${meta.reportDate}`);
  body.appendParagraph(`Project: ${meta.projectName}`);
  body.appendParagraph(`Site Location / Package: ${meta.siteLocation}`);
  if (meta.areaLocation) body.appendParagraph(`Area / Chainage: ${meta.areaLocation}`);
  if (meta.workOrder) body.appendParagraph(`Work Order: ${meta.workOrder}`);
  if (meta.permitNo) body.appendParagraph(`Permit No (PTW): ${meta.permitNo}`);
  if (meta.supervisorName) body.appendParagraph(`Supervisor: ${meta.supervisorName}`);
  if (meta.contractorName) body.appendParagraph(`Contractor/Subcontractor: ${meta.contractorName}`);
  body.appendParagraph(`Inspector: ${meta.inspectorName}`);
  body.appendParagraph("");

  // Geolocation
  if (meta.geo && meta.geo.lat && meta.geo.lng) {
    body.appendParagraph("GEOLOCATION").setHeading(DocumentApp.ParagraphHeading.HEADING2);
    body.appendParagraph(`Latitude: ${meta.geo.lat}`);
    body.appendParagraph(`Longitude: ${meta.geo.lng}`);
    if (meta.geo.accuracyM) body.appendParagraph(`Accuracy (m): ${meta.geo.accuracyM}`);
    body.appendParagraph("");
  }

  // Checklist
  body.appendParagraph("INSPECTION CHECKLIST").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  const checklist = payload.checklist || {};
  const checklistKeys = Object.keys(checklist);

  if (checklistKeys.length === 0) {
    body.appendParagraph("No checklist items recorded.");
  } else {
    const table = body.appendTable([["Item", "Result", "Comments"]]);
    checklistKeys.forEach(k => {
      const item = checklist[k] || {};
      table.appendTableRow()
        .appendTableCell(String(k))
        .getParentRow()
        .appendTableCell(String(item.result || ""))
        .getParentRow()
        .appendTableCell(String(item.comments || ""));
    });
  }
  body.appendParagraph("");

  // Observations
  body.appendParagraph("OBSERVATIONS").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  if (Array.isArray(payload.observations) && payload.observations.length > 0) {
    payload.observations.forEach((o, i) => body.appendListItem(`${i + 1}. ${String(o).trim()}`));
  } else {
    body.appendParagraph("No observations recorded.");
  }
  body.appendParagraph("");

  // Corrective Actions
  body.appendParagraph("CORRECTIVE ACTIONS (CAPA)").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  if (Array.isArray(payload.correctiveActions) && payload.correctiveActions.length > 0) {
    const t = body.appendTable([["Action", "Owner", "Target Date", "Status", "Closeout Notes"]]);
    payload.correctiveActions.forEach(a => {
      const row = t.appendTableRow();
      row.appendTableCell(String(a.action || ""));
      row.appendTableCell(String(a.owner || ""));
      row.appendTableCell(String(a.targetDate || ""));
      row.appendTableCell(String(a.status || ""));
      row.appendTableCell(String(a.closeoutNotes || ""));
    });
  } else {
    body.appendParagraph("No corrective actions recorded.");
  }
  body.appendParagraph("");

  // Evidence: Photos
  body.appendParagraph("PHOTO EVIDENCE").setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const photos = listFilesByPrefix_(recordFolder, "photo_");
  if (photos.length === 0) {
    body.appendParagraph("No photos uploaded.");
  } else {
    photos.forEach(file => {
      const blob = file.getBlob();
      const img = body.appendImage(blob);
      img.setWidth(520); // fits A4 nicely in DOC
      body.appendParagraph(file.getName());
      const captionFile = findFirstFileByName_(recordFolder, file.getName().replace(/\.(jpg|jpeg|png|webp)$/i, "_caption.txt"));
      if (captionFile) {
        body.appendParagraph("Caption: " + captionFile.getBlob().getDataAsString("UTF-8"));
      }
      body.appendParagraph("");
    });
  }

  // Signature
  body.appendParagraph("INSPECTOR SIGNATURE").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  const sig = findFirstFileByName_(recordFolder, "signature.png");
  if (sig) {
    const img = body.appendImage(sig.getBlob());
    img.setWidth(220);
  } else {
    body.appendParagraph("No signature captured.");
  }

  body.appendParagraph("");
  body.appendParagraph(`Generated on: ${new Date().toISOString()}`);

  doc.saveAndClose();

  // Move Doc into the record folder
  const docFile = DriveApp.getFileById(docId);
  recordFolder.addFile(docFile);

  // Export to DOCX and save into same folder
  const exportBlob = docFile.getBlob().getAs(MimeType.MICROSOFT_WORD);
  const docxName = `${docTitle}.docx`;
  const docxFile = recordFolder.createFile(exportBlob.setName(docxName));

  return {
    recordFolderId,
    googleDocId: docId,
    googleDocUrl: `https://docs.google.com/document/d/${docId}/edit`,
    docxFileId: docxFile.getId(),
    docxFileName: docxFile.getName()
  };
}

// ===========================
// AUTH / DIAGNOSTICS
// ===========================

function testAuthorize_() {
  assertDriveAppAvailable_();
  // Touch Drive & Document scopes
  const root = DriveApp.getRootFolder().getName();
  Logger.log("Drive OK. Root: " + root);

  const d = DocumentApp.create("AUTH_TEST_HSE_DOC_" + new Date().toISOString().replace(/[:.]/g, "_"));
  Logger.log("Document OK. DocId: " + d.getId());
  DriveApp.getFileById(d.getId()).setTrashed(true);
}

function driveSanityCheck_() {
  const out = { driveAppType: typeof DriveApp, canReadRoot: false, rootName: "", note: "" };
  try {
    assertDriveAppAvailable_();
    out.rootName = DriveApp.getRootFolder().getName();
    out.canReadRoot = true;
  } catch (e) {
    out.note = formatError_(e);
  }
  return out;
}

function validateToken_(payload) {
  const token = String(payload.apiToken || "").trim();
  if (!token) {
    if (!ALLOW_NO_TOKEN_FOR_TESTING) return { ok: false, statusCode: 401, message: "Unauthorized (token missing)." };
  } else if (token !== API_TOKEN) {
    return { ok: false, statusCode: 401, message: "Unauthorized (invalid token)." };
  }
  return { ok: true, statusCode: 200 };
}

function assertDriveAppAvailable_() {
  if (typeof DriveApp === "undefined" || !DriveApp) {
    throw new Error("DriveApp is not available. Ensure Drive scope exists and deployment is correct.");
  }
  if (typeof DriveApp.getFolderById !== "function") {
    throw new Error("DriveApp.getFolderById is not a function. DriveApp is likely shadowed by a variable.");
  }
}

function safeGetFolderById_(folderId, label) {
  try {
    return DriveApp.getFolderById(folderId);
  } catch (e) {
    throw new Error(
      `Folder access failed (${label || "Folder"}). FolderId=${folderId}. ` +
      `Check folder ownership/permissions + Execute as: Me + redeploy NEW VERSION. ` +
      `Error=${formatError_(e)}`
    );
  }
}

// ===========================
// FILE HELPERS
// ===========================

function findFirstFileByName_(folder, name) {
  const it = folder.getFilesByName(name);
  return it.hasNext() ? it.next() : null;
}

function listFilesByPrefix_(folder, prefix) {
  const files = [];
  const it = folder.getFiles();
  while (it.hasNext()) {
    const f = it.next();
    if (String(f.getName()).startsWith(prefix)) files.push(f);
  }
  files.sort((a, b) => a.getName().localeCompare(b.getName()));
  return files;
}

// ===========================
// OTHER HELPERS
// ===========================

function jsonResponse_(obj, statusCode) {
  const body = { statusCode: statusCode || 200, ...obj };
  return ContentService.createTextOutput(JSON.stringify(body)).setMimeType(ContentService.MimeType.JSON);
}

function safeActiveUserEmail_() {
  try {
    const u = Session.getActiveUser();
    if (u && typeof u.getEmail === "function") return u.getEmail() || "";
  } catch (e) {}
  return "";
}

function getOrCreateFolderIn_(parentFolder, name) {
  const it = parentFolder.getFoldersByName(name);
  return it.hasNext() ? it.next() : parentFolder.createFolder(name);
}

function sanitize_(value) {
  return String(value).trim().replace(/[\/\\:*?"<>|]/g, "_").replace(/\s+/g, " ").substring(0, 120);
}

function dataUrlToBlob_(dataUrl, filename) {
  const parts = String(dataUrl).split(",");
  const meta = parts[0] || "";
  const b64 = parts[1] || "";
  const mimeMatch = meta.match(/data:(.*?);base64/);
  const mime = (mimeMatch && mimeMatch[1]) ? mimeMatch[1] : "image/png";
  const bytes = Utilities.base64Decode(b64);
  return Utilities.newBlob(bytes, mime, filename);
}

function guessExt_(dataUrl) {
  const meta = String(dataUrl).split(",")[0] || "";
  const mimeMatch = meta.match(/data:(.*?);base64/);
  const mime = (mimeMatch && mimeMatch[1]) ? mimeMatch[1] : "image/png";
  if (mime.includes("jpeg") || mime.includes("jpg")) return "jpg";
  if (mime.includes("png")) return "png";
  if (mime.includes("webp")) return "webp";
  return "png";
}

function buildReportNumber_(reportDate) {
  const ymd = String(reportDate).replace(/-/g, "");
  const rnd = Math.floor(1000 + Math.random() * 9000);
  return `HSE-${ymd}-${rnd}`;
}

function buildSummaryText_(payload, meta) {
  const lines = [];
  lines.push("DAILY HSE INSPECTION REPORT SUMMARY");
  lines.push("==================================");
  lines.push(`Project: ${meta.projectName || "(not provided)"}`);
  lines.push(`Report No: ${meta.reportNumber}`);
  lines.push(`Date: ${meta.reportDate}`);
  lines.push(`Site/Area: ${meta.siteLocation}`);
  lines.push(`Inspector: ${meta.inspectorName}`);
  lines.push("");
  return lines.join("\n");
}

function formatError_(err) {
  try {
    if (!err) return "Unknown error";
    if (err.stack) return String(err.stack);
    return String(err);
  } catch (e) {
    return "Error formatting error.";
  }
}
