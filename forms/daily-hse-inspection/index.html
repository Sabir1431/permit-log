<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily HSE Inspection Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#f4f7f6; color:#333; margin:0; padding:0; line-height:1.6; }
    .container { max-width: 980px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,.1); }
    h1 { font-size: 2.25rem; text-align:center; margin: 0 0 1.5rem; color:#1a73e8; font-weight: 800; }
    fieldset { border: 1px solid #e6e6e6; border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem; background:#fafafa; }
    legend { font-size: 1.1rem; font-weight: 700; padding: 0 0.5rem; color:#1a73e8; }
    label { display:block; font-weight:600; margin-bottom:.4rem; color:#444; }
    input[type="text"], input[type="date"], input[type="number"], textarea, select {
      width:100%; padding:.75rem; border:1px solid #ccc; border-radius: 8px; box-sizing:border-box; font-size: 1rem;
      transition: border-color .2s, box-shadow .2s; background:#fff;
    }
    input:focus, textarea:focus, select:focus { border-color:#1a73e8; outline:none; box-shadow: 0 0 0 3px rgba(26,115,232,.18); }
    textarea { min-height: 90px; resize: vertical; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    .help { color:#6b7280; font-size:.85rem; margin:.25rem 0 1rem; }
    .checklist-item { display:flex; flex-wrap:wrap; align-items:center; gap:.75rem; margin-bottom:1rem; padding: 1rem; background:#fff; border-radius: 10px; border:1px solid #eee; }
    .checklist-item > .item-label { flex: 1; font-weight: 600; }
    .radio-group { display:flex; gap: 1rem; }
    .radio-group label { font-weight: 500; margin:0; display:flex; align-items:center; cursor:pointer; }
    .radio-group input { margin-right:.35rem; }
    .checklist-comments { flex-basis: 100%; }
    .photo-upload-container, .observation-container, .capa-container {
      border: 1px dashed #cfcfcf; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; background:#fff;
    }
    .photo-preview { max-width:100%; height:auto; margin-top:.75rem; border-radius:10px; border:1px solid #ddd; }
    .signature-pad-container { border:1px solid #ccc; border-radius:10px; background:#fff; padding: 1rem; text-align:center; }
    #signaturePad { border:1px solid #ddd; border-radius:10px; background:#fdfdfd; cursor: crosshair; width: 100%; height: 220px; }
    .btn-row { display:flex; justify-content:center; gap: .75rem; flex-wrap: wrap; margin-top: .75rem; }
    button { padding:.75rem 1.25rem; border:none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor:pointer; transition: transform .1s, background-color .2s; }
    button:hover { transform: translateY(-1px); }
    .primary { background:#1a73e8; color:#fff; }
    .primary:hover { background:#155cb0; }
    .secondary { background:#e5e7eb; color:#111827; }
    .secondary:hover { background:#d1d5db; }
    .add { background:#16a34a; color:#fff; }
    .add:hover { background:#15803d; }
    .remove { background:#dc2626; color:#fff; }
    .remove:hover { background:#b91c1c; }
    .hidden { display:none; }
    .badge { display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .6rem; border-radius: 999px; font-size:.85rem; font-weight: 700; }
    .badge-ok { background: rgba(22,163,74,.12); color:#166534; }
    .badge-warn { background: rgba(234,179,8,.14); color:#854d0e; }
    .badge-bad { background: rgba(220,38,38,.12); color:#7f1d1d; }
    @media (max-width: 720px) { .grid2,.grid3 { grid-template-columns: 1fr; } .container{ margin:1rem; padding: 1rem; } }
  </style>
</head>

<body class="min-h-screen">
  <div class="container">
    <h1>Daily HSE Inspection Report</h1>

    <form id="hseReportForm">
      <fieldset>
        <legend>General Information</legend>
        <p class="help">This form submits the inspection record to Google Drive under the selected project folder (Year → Site → Report Number).</p>

        <div class="grid2">
          <div>
            <label for="reportNumber">Report Number (Auto)</label>
            <input type="text" id="reportNumber" name="reportNumber" readonly />
            <p class="help">Format: HSE-YYYYMMDD-XXXX</p>
          </div>
          <div>
            <label for="reportDate">Date of Inspection</label>
            <input type="date" id="reportDate" name="reportDate" required />
          </div>
        </div>

        <div class="grid2">
          <div>
            <label for="projectName">Project</label>
            <select id="projectName" name="projectName" required>
              <option value="" disabled selected>Select project</option>
              <option value="TAQA WS O-16123">TAQA WS O-16123</option>
              <option value="TAQA WS O-16124">TAQA WS O-16124</option>
            </select>
          </div>
          <div>
            <label for="siteLocation">Site Location / Package</label>
            <input type="text" id="siteLocation" name="siteLocation" placeholder="e.g., Bani Yas / WO-82A / MH-29 Area" required />
          </div>
        </div>

        <div class="grid3">
          <div>
            <label for="areaLocation">Area / Chainage</label>
            <input type="text" id="areaLocation" name="areaLocation" placeholder="e.g., MH-29/1A to Ext. MH-26" />
          </div>
          <div>
            <label for="workOrder">Work Order</label>
            <input type="text" id="workOrder" name="workOrder" placeholder="e.g., WO 82A" />
          </div>
          <div>
            <label for="permitNo">Permit No. (PTW)</label>
            <input type="text" id="permitNo" name="permitNo" placeholder="e.g., PTW-EXC-000123" />
          </div>
        </div>

        <div class="grid3">
          <div>
            <label for="supervisorName">Supervisor</label>
            <input type="text" id="supervisorName" name="supervisorName" placeholder="e.g., Site Supervisor name" />
          </div>
          <div>
            <label for="contractorName">Contractor / Subcontractor</label>
            <input type="text" id="contractorName" name="contractorName" placeholder="e.g., Hydropower / IFG / etc." />
          </div>
          <div>
            <label for="inspectorName">Inspector Name</label>
            <input type="text" id="inspectorName" name="inspectorName" placeholder="e.g., HSE Officer / Inspector" required />
          </div>
        </div>

        <input type="hidden" id="projectFolderId" name="projectFolderId" />
        <input type="hidden" id="apiToken" name="apiToken" />
      </fieldset>

      <fieldset>
        <legend>Geolocation (Optional)</legend>
        <p class="help">Capture GPS coordinates to strengthen evidence packs. If not required, leave blank.</p>

        <div class="btn-row" style="justify-content:flex-start">
          <button type="button" id="getLocationBtn" class="secondary">Get Current Location</button>
          <span id="geoStatus" class="badge badge-warn hidden">Waiting for GPS…</span>
          <span id="geoOk" class="badge badge-ok hidden">Location captured</span>
          <span id="geoErr" class="badge badge-bad hidden">Location not available</span>
        </div>

        <div class="grid3" style="margin-top: .75rem;">
          <div>
            <label for="geoLat">Latitude</label>
            <input type="text" id="geoLat" name="geoLat" readonly />
          </div>
          <div>
            <label for="geoLng">Longitude</label>
            <input type="text" id="geoLng" name="geoLng" readonly />
          </div>
          <div>
            <label for="geoAcc">Accuracy (m)</label>
            <input type="text" id="geoAcc" name="geoAcc" readonly />
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Inspection Checklist</legend>
        <p class="help">Select Yes/No/N/A and add comments if required.</p>

        <div class="checklist-item">
          <div class="item-label">Personal Protective Equipment (PPE) Used Correctly?</div>
          <div class="radio-group">
            <label><input type="radio" name="checklist-ppe" value="Yes" required>Yes</label>
            <label><input type="radio" name="checklist-ppe" value="No">No</label>
            <label><input type="radio" name="checklist-ppe" value="N/A">N/A</label>
          </div>
          <div class="checklist-comments">
            <label for="checklist-ppe-comments">Comments</label>
            <textarea id="checklist-ppe-comments" name="checklist-ppe-comments" placeholder="Details if No or N/A"></textarea>
          </div>
        </div>

        <div class="checklist-item">
          <div class="item-label">Good Housekeeping Practices Maintained?</div>
          <div class="radio-group">
            <label><input type="radio" name="checklist-housekeeping" value="Yes" required>Yes</label>
            <label><input type="radio" name="checklist-housekeeping" value="No">No</label>
            <label><input type="radio" name="checklist-housekeeping" value="N/A">N/A</label>
          </div>
          <div class="checklist-comments">
            <label for="checklist-housekeeping-comments">Comments</label>
            <textarea id="checklist-housekeeping-comments" name="checklist-housekeeping-comments" placeholder="Details if No or N/A"></textarea>
          </div>
        </div>

        <div class="checklist-item">
          <div class="item-label">Emergency Exits Clearly Marked and Accessible?</div>
          <div class="radio-group">
            <label><input type="radio" name="checklist-exits" value="Yes" required>Yes</label>
            <label><input type="radio" name="checklist-exits" value="No">No</label>
            <label><input type="radio" name="checklist-exits" value="N/A">N/A</label>
          </div>
          <div class="checklist-comments">
            <label for="checklist-exits-comments">Comments</label>
            <textarea id="checklist-exits-comments" name="checklist-exits-comments" placeholder="Details if No or N/A"></textarea>
          </div>
        </div>

        <div class="checklist-item">
          <div class="item-label">Tools and Equipment in Safe Working Condition?</div>
          <div class="radio-group">
            <label><input type="radio" name="checklist-tools" value="Yes" required>Yes</label>
            <label><input type="radio" name="checklist-tools" value="No">No</label>
            <label><input type="radio" name="checklist-tools" value="N/A">N/A</label>
          </div>
          <div class="checklist-comments">
            <label for="checklist-tools-comments">Comments</label>
            <textarea id="checklist-tools-comments" name="checklist-tools-comments" placeholder="Details if No or N/A"></textarea>
          </div>
        </div>

        <div class="checklist-item">
          <div class="item-label">Fire Extinguishers Available and Inspected?</div>
          <div class="radio-group">
            <label><input type="radio" name="checklist-fire" value="Yes" required>Yes</label>
            <label><input type="radio" name="checklist-fire" value="No">No</label>
            <label><input type="radio" name="checklist-fire" value="N/A">N/A</label>
          </div>
          <div class="checklist-comments">
            <label for="checklist-fire-comments">Comments</label>
            <textarea id="checklist-fire-comments" name="checklist-fire-comments" placeholder="Details if No or N/A"></textarea>
          </div>
        </div>

        <div class="checklist-item">
          <div class="item-label">First Aid Kit Stocked and Accessible?</div>
          <div class="radio-group">
            <label><input type="radio" name="checklist-firstaid" value="Yes" required>Yes</label>
            <label><input type="radio" name="checklist-firstaid" value="No">No</label>
            <label><input type="radio" name="checklist-firstaid" value="N/A">N/A</label>
          </div>
          <div class="checklist-comments">
            <label for="checklist-firstaid-comments">Comments</label>
            <textarea id="checklist-firstaid-comments" name="checklist-firstaid-comments" placeholder="Details if No or N/A"></textarea>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Corrective Actions (CAPA)</legend>
        <p class="help">Add corrective actions raised during inspection (Owner + target date + status).</p>

        <div id="capaContainers">
          <div class="capa-container" id="capaContainer-1">
            <div class="grid2">
              <div>
                <label for="capaAction-1">Corrective Action</label>
                <textarea id="capaAction-1" name="capaAction-1" placeholder="Describe the corrective action"></textarea>
              </div>
              <div>
                <label for="capaCloseout-1">Closeout Notes</label>
                <textarea id="capaCloseout-1" name="capaCloseout-1" placeholder="Evidence / remarks for closure (if any)"></textarea>
              </div>
            </div>

            <div class="grid3" style="margin-top:.75rem;">
              <div>
                <label for="capaOwner-1">Owner</label>
                <input type="text" id="capaOwner-1" name="capaOwner-1" placeholder="Responsible person" />
              </div>
              <div>
                <label for="capaTarget-1">Target Date</label>
                <input type="date" id="capaTarget-1" name="capaTarget-1" />
              </div>
              <div>
                <label for="capaStatus-1">Status</label>
                <select id="capaStatus-1" name="capaStatus-1">
                  <option value="" selected>-- Select --</option>
                  <option value="Open">Open</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Closed">Closed</option>
                </select>
              </div>
            </div>

            <div class="btn-row" style="justify-content:flex-end">
              <button type="button" class="remove remove-capa-btn">Remove Action</button>
            </div>
          </div>
        </div>

        <div class="btn-row" style="justify-content:flex-start">
          <button type="button" id="addCapaBtn" class="add">Add Another Action</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Photo Evidence</legend>
        <p class="help">Upload photos (non-compliance, housekeeping, barricading, permits, etc.).</p>

        <div id="photoContainers">
          <div class="photo-upload-container" id="photoContainer-1">
            <div class="grid2">
              <div>
                <label for="photoUpload-1">Upload Photo 1</label>
                <input type="file" id="photoUpload-1" name="photoUpload-1" accept="image/*" capture="camera" />
                <img id="photoPreview-1" class="photo-preview hidden" alt="Photo Preview"/>
              </div>
              <div>
                <label for="photoCaption-1">Caption</label>
                <textarea id="photoCaption-1" name="photoCaption-1" placeholder="Describe the photo"></textarea>
              </div>
            </div>

            <div class="btn-row" style="justify-content:flex-end">
              <button type="button" class="remove remove-photo-btn">Remove Photo</button>
            </div>
          </div>
        </div>

        <div class="btn-row" style="justify-content:flex-start">
          <button type="button" id="addPhotoBtn" class="add">Add Another Photo</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Observations</legend>
        <p class="help">Record any observations, positive findings, or concerns.</p>

        <div id="observationContainers">
          <div class="observation-container" id="observationContainer-1">
            <label for="observation-1">Observation 1</label>
            <textarea id="observation-1" name="observation-1" placeholder="Enter your observation"></textarea>
            <div class="btn-row" style="justify-content:flex-end">
              <button type="button" class="remove remove-observation-btn">Remove Observation</button>
            </div>
          </div>
        </div>

        <div class="btn-row" style="justify-content:flex-start">
          <button type="button" id="addObservationBtn" class="add">Add Another Observation</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Inspector Signature</legend>
        <p class="help">Sign using mouse or touch. The signature is stored in Drive as signature.png.</p>

        <div class="signature-pad-container">
          <canvas id="signaturePad"></canvas>

          <div class="btn-row">
            <button type="button" id="clearSignatureBtn" class="secondary">Clear Signature</button>
          </div>

          <input type="hidden" id="signatureData" name="signatureData" />
          <img id="signaturePreview" class="photo-preview hidden" alt="Signature Preview"/>
        </div>
      </fieldset>

      <div class="btn-row" style="margin-top: 1.25rem;">
        <button type="submit" class="primary">Submit HSE Report</button>
      </div>
    </form>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // =====================
  // CONFIG - UPDATE IF NEEDED
  // =====================
  const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxRm8asg1KLaRKeIYaoEn2LsgqQXAzHgJT4iWYEafnT_hy2Z5U7lbPhyQhziHqULyIZoQ/exec';

  // IMPORTANT: set the same token as in Apps Script (API_TOKEN)
  const API_TOKEN = 'HSE-TAQA-2026-SECURE-KEY-98321';

  // Project → Folder ID mapping (used by Apps Script)
  const PROJECT_FOLDER_MAP = {
  'TAQA WS O-16123': '1gMRc-OhcScKCDz5Z4xRI3Ba49if8pQBC',
  'TAQA WS O-16124': '1A7rrudDh4KBd6c6DsiA0bnCe7PtDx7mF'
/**
 * HSE Inspection Web App (Drive + Word Export)
 * - doPost: saves payload to Drive (same as your current flow)
 * - NEW: /exec?mode=export&folderId=...  OR POST { mode:"export", folderId:"..." }
 * - Generates Google Doc report from report.json + images in the same folder
 * - Exports as DOCX into the same folder
 *
 * DEPLOY:
 * - Execute as: Me (USER_DEPLOYING)
 * - Access: Anyone
 * - After adding Documents scope: Run testAuthorize_() then Deploy NEW VERSION
 */

// ===========================
// CONFIGURATION
// ===========================
const PROJECT_FOLDERS = {
  "TAQA WS O-16123": "1gMRc-OhcScKCDz5Z4xRI3Ba49if8pQBC",
  "TAQA WS O-16124": "1A7rrudDh4KBd6c6DsiA0bnCe7PtDx7mF"
};

const API_TOKEN = "HSE-TAQA-2026-SECURE-KEY-98321";
const ALLOW_NO_TOKEN_FOR_TESTING = false;
const ALLOWED_DOMAIN = ""; // keep "" to disable

  // =====================
  // ELEMENTS
  // =====================
  const hseReportForm = document.getElementById('hseReportForm');
// ===========================
// ENTRY POINTS
// ===========================

  const reportDateInput = document.getElementById('reportDate');
  const reportNumberInput = document.getElementById('reportNumber');
function doGet(e) {
  const mode = (e && e.parameter && e.parameter.mode) ? String(e.parameter.mode) : "health";

  const projectNameSelect = document.getElementById('projectName');
  const projectFolderIdInput = document.getElementById('projectFolderId');
  if (mode === "drive") {
    const sanity = driveSanityCheck_();
    return jsonResponse_({ ok: true, mode: "drive", driveSanity: sanity }, 200);
  }

  const apiTokenInput = document.getElementById('apiToken');
  apiTokenInput.value = API_TOKEN;
  if (mode === "export") {
    const folderId = (e && e.parameter && e.parameter.folderId) ? String(e.parameter.folderId) : "";
    if (!folderId) return jsonResponse_({ ok: false, message: "Missing folderId for export." }, 400);

  // Geolocation
  const getLocationBtn = document.getElementById('getLocationBtn');
  const geoLat = document.getElementById('geoLat');
  const geoLng = document.getElementById('geoLng');
  const geoAcc = document.getElementById('geoAcc');
  const geoStatus = document.getElementById('geoStatus');
  const geoOk = document.getElementById('geoOk');
  const geoErr = document.getElementById('geoErr');

  // Photos
  let photoCounter = 1;
  const photoContainers = document.getElementById('photoContainers');
  const addPhotoBtn = document.getElementById('addPhotoBtn');
    const result = createAndExportWordReport_(folderId);
    return jsonResponse_({ ok: true, mode: "export", ...result }, 200);
  }

  // Observations
  let observationCounter = 1;
  const observationContainers = document.getElementById('observationContainers');
  const addObservationBtn = document.getElementById('addObservationBtn');
  return jsonResponse_({
    ok: true,
    mode: "health",
    message: "HSE Inspection Drive API is running.",
    projects: Object.keys(PROJECT_FOLDERS),
    hint: "Use ?mode=drive to verify DriveApp. Use ?mode=export&folderId=FOLDER_ID to create DOCX."
  }, 200);
}

  // CAPA
  let capaCounter = 1;
  const capaContainers = document.getElementById('capaContainers');
  const addCapaBtn = document.getElementById('addCapaBtn');
function doPost(e) {
  try {
    assertDriveAppAvailable_();

  // Signature
  const signaturePadCanvas = document.getElementById('signaturePad');
  const signaturePadCtx = signaturePadCanvas.getContext('2d');
  const clearSignatureBtn = document.getElementById('clearSignatureBtn');
  const signatureDataInput = document.getElementById('signatureData');
  const signaturePreview = document.getElementById('signaturePreview');

  // =====================
  // HELPERS
  // =====================
  const fileToDataUrl = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(reader.error);
    reader.readAsDataURL(file);
  });

  const pad4 = (n) => String(n).padStart(4, '0');

  const ymd = (d) => {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}${mm}${dd}`;
  };
    if (!e || !e.postData || !e.postData.contents) {
      return jsonResponse_({ ok: false, message: "Missing request body." }, 400);
    }

  const generateReportNumber = () => {
    const dateVal = reportDateInput.value;
    const dt = dateVal ? new Date(dateVal + 'T00:00:00') : new Date();
    const rnd = Math.floor(Math.random() * 10000);
    reportNumberInput.value = `HSE-${ymd(dt)}-${pad4(rnd)}`;
  };
    const payload = JSON.parse(e.postData.contents);

    // Optional: allow POST export
    if (String(payload.mode || "").toLowerCase() === "export") {
      const tokenOk = validateToken_(payload);
      if (!tokenOk.ok) return jsonResponse_(tokenOk, tokenOk.statusCode);

  const show = (el) => el.classList.remove('hidden');
  const hide = (el) => el.classList.add('hidden');

  // =====================
  // INIT
  // =====================
  reportDateInput.valueAsDate = new Date();
  generateReportNumber();

  reportDateInput.addEventListener('change', () => generateReportNumber());

  projectNameSelect.addEventListener('change', () => {
    const project = projectNameSelect.value;
    projectFolderIdInput.value = PROJECT_FOLDER_MAP[project] || '';
  });

  // =====================
  // GEOLOCATION
  // =====================
  getLocationBtn.addEventListener('click', () => {
    hide(geoOk); hide(geoErr);
    geoStatus.textContent = 'Waiting for GPS…';
    show(geoStatus);

    if (!navigator.geolocation) {
      hide(geoStatus);
      geoErr.textContent = 'Location not supported by this browser.';
      show(geoErr);
      return;
      const folderId = String(payload.folderId || "").trim();
      if (!folderId) return jsonResponse_({ ok: false, message: "Missing folderId." }, 400);

      const result = createAndExportWordReport_(folderId);
      return jsonResponse_({ ok: true, mode: "export", ...result }, 200);
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        geoLat.value = pos.coords.latitude.toFixed(6);
        geoLng.value = pos.coords.longitude.toFixed(6);
        geoAcc.value = Math.round(pos.coords.accuracy);
        hide(geoStatus);
        show(geoOk);
      },
      (err) => {
        hide(geoStatus);
        geoErr.textContent = err.message || 'Unable to retrieve location.';
        show(geoErr);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  });

  // =====================
  // PHOTOS
  // =====================
  const attachPhotoListeners = (id) => {
    const photoUpload = document.getElementById(`photoUpload-${id}`);
    const photoPreview = document.getElementById(`photoPreview-${id}`);
    const removeBtn = document.querySelector(`#photoContainer-${id} .remove-photo-btn`);

    if (photoUpload) {
      photoUpload.addEventListener('change', (event) => {
        const file = event.target.files && event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            photoPreview.src = e.target.result;
            photoPreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          photoPreview.src = '';
          photoPreview.classList.add('hidden');
        }
      });
    // ---------------------------
    // DOMAIN LOCK (optional)
    // ---------------------------
    if (ALLOWED_DOMAIN) {
      const email = safeActiveUserEmail_();
      if (!email) {
        return jsonResponse_({
          ok: false,
          message: "Unauthorized (cannot verify domain). Disable ALLOWED_DOMAIN or deploy in Workspace."
        }, 401);
      }
      const domain = email.split("@").pop().toLowerCase();
      if (domain !== ALLOWED_DOMAIN.toLowerCase()) {
        return jsonResponse_({ ok: false, message: "Unauthorized (domain not allowed)." }, 401);
      }
    }

    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        const container = document.getElementById(`photoContainer-${id}`);
        if (container && photoContainers.children.length > 1) container.remove();
      });
    // ---------------------------
    // TOKEN VALIDATION
    // ---------------------------
    const tokenOk = validateToken_(payload);
    if (!tokenOk.ok) return jsonResponse_(tokenOk, tokenOk.statusCode);

    // ---------------------------
    // READ REQUIRED FIELDS
    // ---------------------------
    const projectName = String(payload.projectName || "").trim();
    const folderIdFromForm = String(payload.projectFolderId || "").trim();

    const reportDate = String(payload.reportDate || new Date().toISOString().slice(0, 10)).trim();
    const year = reportDate.substring(0, 4);

    const siteLocation = sanitize_(payload.siteLocation || "Unknown_Site");
    const inspectorName = sanitize_(payload.inspectorName || "Unknown_Inspector");
    const reportNumber = sanitize_(payload.reportNumber || buildReportNumber_(reportDate));

    // Resolve project root folder id
    const projectFolderId = folderIdFromForm || PROJECT_FOLDERS[projectName];
    if (!projectFolderId) {
      return jsonResponse_({
        ok: false,
        message: "Project folder not configured. Provide projectFolderId or use a known projectName.",
        projectName
      }, 400);
    }
  };
  attachPhotoListeners(1);

  addPhotoBtn.addEventListener('click', () => {
    photoCounter++;
    const id = photoCounter;

    const container = document.createElement('div');
    container.className = 'photo-upload-container';
    container.id = `photoContainer-${id}`;
    container.innerHTML = `
      <div class="grid2">
        <div>
          <label for="photoUpload-${id}">Upload Photo ${id}</label>
          <input type="file" id="photoUpload-${id}" name="photoUpload-${id}" accept="image/*" capture="camera" />
          <img id="photoPreview-${id}" class="photo-preview hidden" alt="Photo Preview"/>
        </div>
        <div>
          <label for="photoCaption-${id}">Caption</label>
          <textarea id="photoCaption-${id}" name="photoCaption-${id}" placeholder="Describe the photo"></textarea>
        </div>
      </div>
      <div class="btn-row" style="justify-content:flex-end">
        <button type="button" class="remove remove-photo-btn">Remove Photo</button>
      </div>
    `;
    photoContainers.appendChild(container);
    attachPhotoListeners(id);
  });

  // =====================
  // OBSERVATIONS
  // =====================
  const attachObservationListeners = (id) => {
    const removeBtn = document.querySelector(`#observationContainer-${id} .remove-observation-btn`);
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        const container = document.getElementById(`observationContainer-${id}`);
        if (container && observationContainers.children.length > 1) container.remove();
      });

    // Create structure
    const projectRoot = safeGetFolderById_(projectFolderId, "ProjectRoot");
    const yearFolder = getOrCreateFolderIn_(projectRoot, year);
    const siteFolder = getOrCreateFolderIn_(yearFolder, siteLocation);
    const recordFolder = getOrCreateFolderIn_(siteFolder, reportNumber);

    // Save payload
    payload._server = {
      savedAt: new Date().toISOString(),
      savedBy: safeActiveUserEmail_(),
      projectNameResolved: projectName || "(from folderId)",
      driveFolderId: recordFolder.getId(),
      inspectorName
    };

    recordFolder.createFile("report.json", JSON.stringify(payload, null, 2), MimeType.JSON);

    if (payload.renderedHtml && String(payload.renderedHtml).trim().length > 0) {
      recordFolder.createFile("report.html", String(payload.renderedHtml), MimeType.HTML);
    }
  };
  attachObservationListeners(1);

  addObservationBtn.addEventListener('click', () => {
    observationCounter++;
    const id = observationCounter;

    const container = document.createElement('div');
    container.className = 'observation-container';
    container.id = `observationContainer-${id}`;
    container.innerHTML = `
      <label for="observation-${id}">Observation ${id}</label>
      <textarea id="observation-${id}" name="observation-${id}" placeholder="Enter your observation"></textarea>
      <div class="btn-row" style="justify-content:flex-end">
        <button type="button" class="remove remove-observation-btn">Remove Observation</button>
      </div>
    `;
    observationContainers.appendChild(container);
    attachObservationListeners(id);
  });

  // =====================
  // CAPA
  // =====================
  const attachCapaListeners = (id) => {
    const removeBtn = document.querySelector(`#capaContainer-${id} .remove-capa-btn`);
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        const container = document.getElementById(`capaContainer-${id}`);
        if (container && capaContainers.children.length > 1) container.remove();

    // signature
    if (payload.signatureData && String(payload.signatureData).startsWith("data:image")) {
      const sigBlob = dataUrlToBlob_(payload.signatureData, "signature.png");
      recordFolder.createFile(sigBlob);
    }

    // photos
    if (Array.isArray(payload.photos) && payload.photos.length > 0) {
      payload.photos.forEach((p, idx) => {
        if (!p || !p.dataUrl || !String(p.dataUrl).startsWith("data:image")) return;

        const ext = guessExt_(p.dataUrl);
        const name = `photo_${String(idx + 1).padStart(2, "0")}.${ext}`;
        const blob = dataUrlToBlob_(p.dataUrl, name);
        recordFolder.createFile(blob);

        if (p.caption && String(p.caption).trim().length > 0) {
          recordFolder.createFile(
            `photo_${String(idx + 1).padStart(2, "0")}_caption.txt`,
            String(p.caption).trim(),
            MimeType.PLAIN_TEXT
          );
        }
      });
    }
  };
  attachCapaListeners(1);

  addCapaBtn.addEventListener('click', () => {
    capaCounter++;
    const id = capaCounter;

    const container = document.createElement('div');
    container.className = 'capa-container';
    container.id = `capaContainer-${id}`;
    container.innerHTML = `
      <div class="grid2">
        <div>
          <label for="capaAction-${id}">Corrective Action</label>
          <textarea id="capaAction-${id}" name="capaAction-${id}" placeholder="Describe the corrective action"></textarea>
        </div>
        <div>
          <label for="capaCloseout-${id}">Closeout Notes</label>
          <textarea id="capaCloseout-${id}" name="capaCloseout-${id}" placeholder="Evidence / remarks for closure (if any)"></textarea>
        </div>
      </div>

      <div class="grid3" style="margin-top:.75rem;">
        <div>
          <label for="capaOwner-${id}">Owner</label>
          <input type="text" id="capaOwner-${id}" name="capaOwner-${id}" placeholder="Responsible person" />
        </div>
        <div>
          <label for="capaTarget-${id}">Target Date</label>
          <input type="date" id="capaTarget-${id}" name="capaTarget-${id}" />
        </div>
        <div>
          <label for="capaStatus-${id}">Status</label>
          <select id="capaStatus-${id}" name="capaStatus-${id}">
            <option value="" selected>-- Select --</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
      </div>

      <div class="btn-row" style="justify-content:flex-end">
        <button type="button" class="remove remove-capa-btn">Remove Action</button>
      </div>
    `;
    capaContainers.appendChild(container);
    attachCapaListeners(id);
  });

  // =====================
  // SIGNATURE PAD
  // =====================
  const resizeCanvas = () => {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    signaturePadCanvas.width = signaturePadCanvas.offsetWidth * ratio;
    signaturePadCanvas.height = signaturePadCanvas.offsetHeight * ratio;
    signaturePadCtx.setTransform(ratio, 0, 0, ratio, 0, 0);
  };
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  let drawing = false;
  let lastX = 0, lastY = 0;
    // summary
    const summary = buildSummaryText_(payload, {
      projectName,
      reportNumber,
      reportDate,
      siteLocation,
      inspectorName
    });
    recordFolder.createFile("summary.txt", summary, MimeType.PLAIN_TEXT);

    return jsonResponse_({
      ok: true,
      message: "Saved to Google Drive",
      projectName,
      reportNumber,
      folderName: recordFolder.getName(),
      folderId: recordFolder.getId()
    }, 200);

  } catch (err) {
    return jsonResponse_({ ok: false, message: formatError_(err) }, 500);
  }
}

  const getPos = (evt) => {
    const rect = signaturePadCanvas.getBoundingClientRect();
    if (evt.touches && evt.touches.length > 0) {
      return [evt.touches[0].clientX - rect.left, evt.touches[0].clientY - rect.top];
    }
    return [evt.clientX - rect.left, evt.clientY - rect.top];
  };
// ===========================
// WORD EXPORT (DOCX) - MAIN
// ===========================

  const start = (e) => { drawing = true; [lastX,lastY] = getPos(e); };
  const move = (e) => {
    if (!drawing) return;
    e.preventDefault();
    const [x,y] = getPos(e);
    signaturePadCtx.beginPath();
    signaturePadCtx.moveTo(lastX,lastY);
    signaturePadCtx.lineTo(x,y);
    signaturePadCtx.strokeStyle = '#000';
    signaturePadCtx.lineWidth = 2;
    signaturePadCtx.lineCap = 'round';
    signaturePadCtx.lineJoin = 'round';
    signaturePadCtx.stroke();
    [lastX,lastY] = [x,y];
  };
  const stop = () => { drawing = false; };

  signaturePadCanvas.addEventListener('mousedown', start);
  signaturePadCanvas.addEventListener('mousemove', move);
  signaturePadCanvas.addEventListener('mouseup', stop);
  signaturePadCanvas.addEventListener('mouseout', stop);

  signaturePadCanvas.addEventListener('touchstart', start, { passive:false });
  signaturePadCanvas.addEventListener('touchmove', move, { passive:false });
  signaturePadCanvas.addEventListener('touchend', stop);
  signaturePadCanvas.addEventListener('touchcancel', stop);

  const isCanvasEmpty = () => {
    const blank = document.createElement('canvas');
    blank.width = signaturePadCanvas.width;
    blank.height = signaturePadCanvas.height;
    return signaturePadCanvas.toDataURL() === blank.toDataURL();
function createAndExportWordReport_(recordFolderId) {
  assertDriveAppAvailable_();

  // Ensure DocumentApp is available
  if (typeof DocumentApp === "undefined" || !DocumentApp) {
    throw new Error("DocumentApp is not available. Ensure Documents scope is added and you redeployed a NEW VERSION.");
  }

  const recordFolder = safeGetFolderById_(recordFolderId, "RecordFolder");

  // Load report.json
  const reportFile = findFirstFileByName_(recordFolder, "report.json");
  if (!reportFile) {
    throw new Error("report.json not found in the record folder. Cannot generate report.");
  }

  const payload = JSON.parse(reportFile.getBlob().getDataAsString("UTF-8"));

  const meta = {
    reportNumber: payload.reportNumber || recordFolder.getName(),
    reportDate: payload.reportDate || "",
    projectName: payload.projectName || "",
    siteLocation: payload.siteLocation || "",
    areaLocation: payload.areaLocation || "",
    workOrder: payload.workOrder || "",
    permitNo: payload.permitNo || "",
    supervisorName: payload.supervisorName || "",
    contractorName: payload.contractorName || "",
    inspectorName: payload.inspectorName || "",
    geo: payload.geolocation || {}
  };

  clearSignatureBtn.addEventListener('click', () => {
    signaturePadCtx.clearRect(0,0,signaturePadCanvas.width, signaturePadCanvas.height);
    signatureDataInput.value = '';
    signaturePreview.src = '';
    signaturePreview.classList.add('hidden');
  });

  // =====================
  // SUBMIT
  // =====================
  hseReportForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    if (!projectNameSelect.value) {
      alert('Please select a project.');
      projectNameSelect.focus();
      return;
    }
    projectFolderIdInput.value = PROJECT_FOLDER_MAP[projectNameSelect.value] || '';
  // Create Google Doc
  const docTitle = `HSE Inspection Report - ${meta.reportNumber}`;
  const doc = DocumentApp.create(docTitle);
  const docId = doc.getId();

  const body = doc.getBody();
  body.clear();

  // Header
  const title = body.appendParagraph("DAILY HSE INSPECTION REPORT");
  title.setHeading(DocumentApp.ParagraphHeading.HEADING1);

  body.appendParagraph(`Report No: ${meta.reportNumber}`);
  body.appendParagraph(`Date: ${meta.reportDate}`);
  body.appendParagraph(`Project: ${meta.projectName}`);
  body.appendParagraph(`Site Location / Package: ${meta.siteLocation}`);
  if (meta.areaLocation) body.appendParagraph(`Area / Chainage: ${meta.areaLocation}`);
  if (meta.workOrder) body.appendParagraph(`Work Order: ${meta.workOrder}`);
  if (meta.permitNo) body.appendParagraph(`Permit No (PTW): ${meta.permitNo}`);
  if (meta.supervisorName) body.appendParagraph(`Supervisor: ${meta.supervisorName}`);
  if (meta.contractorName) body.appendParagraph(`Contractor/Subcontractor: ${meta.contractorName}`);
  body.appendParagraph(`Inspector: ${meta.inspectorName}`);
  body.appendParagraph("");

    if (!signatureDataInput.value && !isCanvasEmpty()) {
      const sig = signaturePadCanvas.toDataURL('image/png');
      signatureDataInput.value = sig;
      signaturePreview.src = sig;
      signaturePreview.classList.remove('hidden');
    }
  // Geolocation
  if (meta.geo && meta.geo.lat && meta.geo.lng) {
    body.appendParagraph("GEOLOCATION").setHeading(DocumentApp.ParagraphHeading.HEADING2);
    body.appendParagraph(`Latitude: ${meta.geo.lat}`);
    body.appendParagraph(`Longitude: ${meta.geo.lng}`);
    if (meta.geo.accuracyM) body.appendParagraph(`Accuracy (m): ${meta.geo.accuracyM}`);
    body.appendParagraph("");
  }

    const formData = new FormData(hseReportForm);

    const payload = {
      apiToken: API_TOKEN,
      reportNumber: formData.get('reportNumber') || '',
      reportDate: formData.get('reportDate') || new Date().toISOString().slice(0,10),

      projectName: formData.get('projectName') || '',
     

      siteLocation: formData.get('siteLocation') || '',
      areaLocation: formData.get('areaLocation') || '',
      workOrder: formData.get('workOrder') || '',
      permitNo: formData.get('permitNo') || '',
      supervisorName: formData.get('supervisorName') || '',
      contractorName: formData.get('contractorName') || '',
      inspectorName: formData.get('inspectorName') || '',

      geolocation: {
        lat: geoLat.value || '',
        lng: geoLng.value || '',
        accuracyM: geoAcc.value || ''
      },

      signatureData: formData.get('signatureData') || '',
      checklist: {},
      observations: [],
      correctiveActions: [],
      photos: [],

      submittedAt: new Date().toISOString(),
      userAgent: navigator.userAgent
    };
  // Checklist
  body.appendParagraph("INSPECTION CHECKLIST").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  const checklist = payload.checklist || {};
  const checklistKeys = Object.keys(checklist);

    for (const [key, value] of formData.entries()) {
      if (key.startsWith('checklist-') && !key.endsWith('-comments')) {
        payload.checklist[key] = {
          result: value,
          comments: formData.get(`${key}-comments`) || ''
        };
      }
    }
  if (checklistKeys.length === 0) {
    body.appendParagraph("No checklist items recorded.");
  } else {
    const table = body.appendTable([["Item", "Result", "Comments"]]);
    checklistKeys.forEach(k => {
      const item = checklist[k] || {};
      table.appendTableRow()
        .appendTableCell(String(k))
        .getParentRow()
        .appendTableCell(String(item.result || ""))
        .getParentRow()
        .appendTableCell(String(item.comments || ""));
    });
  }
  body.appendParagraph("");

    for (const [key, value] of formData.entries()) {
      if (key.startsWith('observation-') && value && String(value).trim().length > 0) {
        payload.observations.push(String(value).trim());
      }
    }
  // Observations
  body.appendParagraph("OBSERVATIONS").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  if (Array.isArray(payload.observations) && payload.observations.length > 0) {
    payload.observations.forEach((o, i) => body.appendListItem(`${i + 1}. ${String(o).trim()}`));
  } else {
    body.appendParagraph("No observations recorded.");
  }
  body.appendParagraph("");

  // Corrective Actions
  body.appendParagraph("CORRECTIVE ACTIONS (CAPA)").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  if (Array.isArray(payload.correctiveActions) && payload.correctiveActions.length > 0) {
    const t = body.appendTable([["Action", "Owner", "Target Date", "Status", "Closeout Notes"]]);
    payload.correctiveActions.forEach(a => {
      const row = t.appendTableRow();
      row.appendTableCell(String(a.action || ""));
      row.appendTableCell(String(a.owner || ""));
      row.appendTableCell(String(a.targetDate || ""));
      row.appendTableCell(String(a.status || ""));
      row.appendTableCell(String(a.closeoutNotes || ""));
    });
  } else {
    body.appendParagraph("No corrective actions recorded.");
  }
  body.appendParagraph("");

    const capaBlocks = Array.from(document.querySelectorAll('[id^="capaContainer-"]'));
    capaBlocks.forEach(block => {
      const id = block.id.split('-')[1];
      const action = (document.getElementById(`capaAction-${id}`)?.value || '').trim();
      const owner = (document.getElementById(`capaOwner-${id}`)?.value || '').trim();
      const targetDate = (document.getElementById(`capaTarget-${id}`)?.value || '').trim();
      const status = (document.getElementById(`capaStatus-${id}`)?.value || '').trim();
      const closeoutNotes = (document.getElementById(`capaCloseout-${id}`)?.value || '').trim();

      if (action || owner || targetDate || status || closeoutNotes) {
        payload.correctiveActions.push({ action, owner, targetDate, status, closeoutNotes });
  // Evidence: Photos
  body.appendParagraph("PHOTO EVIDENCE").setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const photos = listFilesByPrefix_(recordFolder, "photo_");
  if (photos.length === 0) {
    body.appendParagraph("No photos uploaded.");
  } else {
    photos.forEach(file => {
      const blob = file.getBlob();
      const img = body.appendImage(blob);
      img.setWidth(520); // fits A4 nicely in DOC
      body.appendParagraph(file.getName());
      const captionFile = findFirstFileByName_(recordFolder, file.getName().replace(/\.(jpg|jpeg|png|webp)$/i, "_caption.txt"));
      if (captionFile) {
        body.appendParagraph("Caption: " + captionFile.getBlob().getDataAsString("UTF-8"));
      }
      body.appendParagraph("");
    });
  }

    const photoUploads = [];
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('photoUpload-') && value instanceof File && value.size > 0) {
        const id = key.split('-')[1];
        photoUploads.push({ id, file: value });
      }
    }
  // Signature
  body.appendParagraph("INSPECTOR SIGNATURE").setHeading(DocumentApp.ParagraphHeading.HEADING2);
  const sig = findFirstFileByName_(recordFolder, "signature.png");
  if (sig) {
    const img = body.appendImage(sig.getBlob());
    img.setWidth(220);
  } else {
    body.appendParagraph("No signature captured.");
  }

    for (const p of photoUploads) {
      try {
        const dataUrl = await fileToDataUrl(p.file);
        const caption = (formData.get(`photoCaption-${p.id}`) || '').toString();
        payload.photos.push({ dataUrl, caption });
      } catch (err) {
        console.warn('Photo read failed:', err);
      }
    }
  body.appendParagraph("");
  body.appendParagraph(`Generated on: ${new Date().toISOString()}`);

    payload.renderedHtml = document.documentElement.outerHTML;
  doc.saveAndClose();

    try {
  const res = await fetch(ENDPOINT_URL, {
    method: 'POST',
    redirect: 'follow',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  });
  // Move Doc into the record folder
  const docFile = DriveApp.getFileById(docId);
  recordFolder.addFile(docFile);

  const text = await res.text();
  console.log("HTTP Status:", res.status);
  console.log("Response:", text);
  // Export to DOCX and save into same folder
  const exportBlob = docFile.getBlob().getAs(MimeType.MICROSOFT_WORD);
  const docxName = `${docTitle}.docx`;
  const docxFile = recordFolder.createFile(exportBlob.setName(docxName));

  let result = null;
  try { result = JSON.parse(text); } catch (e) {}
  return {
    recordFolderId,
    googleDocId: docId,
    googleDocUrl: `https://docs.google.com/document/d/${docId}/edit`,
    docxFileId: docxFile.getId(),
    docxFileName: docxFile.getName()
  };
}

  if (result && result.ok) {
    alert(`Saved to Google Drive.\nReport: ${result.reportNumber}\nFolder ID: ${result.folderId}`);
  } else {
    alert(`Save failed.\nHTTP: ${res.status}\nResponse: ${text}`);
// ===========================
// AUTH / DIAGNOSTICS
// ===========================

function testAuthorize_() {
  assertDriveAppAvailable_();
  // Touch Drive & Document scopes
  const root = DriveApp.getRootFolder().getName();
  Logger.log("Drive OK. Root: " + root);

  const d = DocumentApp.create("AUTH_TEST_HSE_DOC_" + new Date().toISOString().replace(/[:.]/g, "_"));
  Logger.log("Document OK. DocId: " + d.getId());
  DriveApp.getFileById(d.getId()).setTrashed(true);
}

function driveSanityCheck_() {
  const out = { driveAppType: typeof DriveApp, canReadRoot: false, rootName: "", note: "" };
  try {
    assertDriveAppAvailable_();
    out.rootName = DriveApp.getRootFolder().getName();
    out.canReadRoot = true;
  } catch (e) {
    out.note = formatError_(e);
  }
  return out;
}

function validateToken_(payload) {
  const token = String(payload.apiToken || "").trim();
  if (!token) {
    if (!ALLOW_NO_TOKEN_FOR_TESTING) return { ok: false, statusCode: 401, message: "Unauthorized (token missing)." };
  } else if (token !== API_TOKEN) {
    return { ok: false, statusCode: 401, message: "Unauthorized (invalid token)." };
  }
} catch (err) {
  console.error("Network error:", err);
  alert("Submission failed (network/CORS). Open Console (F12) and check the error details.");
  return { ok: true, statusCode: 200 };
}

  });
});
</script>
</body>
</html>
function assertDriveAppAvailable_() {
  if (typeof DriveApp === "undefined" || !DriveApp) {
    throw new Error("DriveApp is not available. Ensure Drive scope exists and deployment is correct.");
  }
  if (typeof DriveApp.getFolderById !== "function") {
    throw new Error("DriveApp.getFolderById is not a function. DriveApp is likely shadowed by a variable.");
  }
}

function safeGetFolderById_(folderId, label) {
  try {
    return DriveApp.getFolderById(folderId);
  } catch (e) {
    throw new Error(
      `Folder access failed (${label || "Folder"}). FolderId=${folderId}. ` +
      `Check folder ownership/permissions + Execute as: Me + redeploy NEW VERSION. ` +
      `Error=${formatError_(e)}`
    );
  }
}

// ===========================
// FILE HELPERS
// ===========================

function findFirstFileByName_(folder, name) {
  const it = folder.getFilesByName(name);
  return it.hasNext() ? it.next() : null;
}

function listFilesByPrefix_(folder, prefix) {
  const files = [];
  const it = folder.getFiles();
  while (it.hasNext()) {
    const f = it.next();
    if (String(f.getName()).startsWith(prefix)) files.push(f);
  }
  files.sort((a, b) => a.getName().localeCompare(b.getName()));
  return files;
}

// ===========================
// OTHER HELPERS
// ===========================

function jsonResponse_(obj, statusCode) {
  const body = { statusCode: statusCode || 200, ...obj };
  return ContentService.createTextOutput(JSON.stringify(body)).setMimeType(ContentService.MimeType.JSON);
}

function safeActiveUserEmail_() {
  try {
    const u = Session.getActiveUser();
    if (u && typeof u.getEmail === "function") return u.getEmail() || "";
  } catch (e) {}
  return "";
}

function getOrCreateFolderIn_(parentFolder, name) {
  const it = parentFolder.getFoldersByName(name);
  return it.hasNext() ? it.next() : parentFolder.createFolder(name);
}

function sanitize_(value) {
  return String(value).trim().replace(/[\/\\:*?"<>|]/g, "_").replace(/\s+/g, " ").substring(0, 120);
}

function dataUrlToBlob_(dataUrl, filename) {
  const parts = String(dataUrl).split(",");
  const meta = parts[0] || "";
  const b64 = parts[1] || "";
  const mimeMatch = meta.match(/data:(.*?);base64/);
  const mime = (mimeMatch && mimeMatch[1]) ? mimeMatch[1] : "image/png";
  const bytes = Utilities.base64Decode(b64);
  return Utilities.newBlob(bytes, mime, filename);
}

function guessExt_(dataUrl) {
  const meta = String(dataUrl).split(",")[0] || "";
  const mimeMatch = meta.match(/data:(.*?);base64/);
  const mime = (mimeMatch && mimeMatch[1]) ? mimeMatch[1] : "image/png";
  if (mime.includes("jpeg") || mime.includes("jpg")) return "jpg";
  if (mime.includes("png")) return "png";
  if (mime.includes("webp")) return "webp";
  return "png";
}

function buildReportNumber_(reportDate) {
  const ymd = String(reportDate).replace(/-/g, "");
  const rnd = Math.floor(1000 + Math.random() * 9000);
  return `HSE-${ymd}-${rnd}`;
}

function buildSummaryText_(payload, meta) {
  const lines = [];
  lines.push("DAILY HSE INSPECTION REPORT SUMMARY");
  lines.push("==================================");
  lines.push(`Project: ${meta.projectName || "(not provided)"}`);
  lines.push(`Report No: ${meta.reportNumber}`);
  lines.push(`Date: ${meta.reportDate}`);
  lines.push(`Site/Area: ${meta.siteLocation}`);
  lines.push(`Inspector: ${meta.inspectorName}`);
  lines.push("");
  return lines.join("\n");
}

function formatError_(err) {
  try {
    if (!err) return "Unknown error";
    if (err.stack) return String(err.stack);
    return String(err);
  } catch (e) {
    return "Error formatting error.";
  }
}
